<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FitBalance — питание, тренировки, профиль</title>
  <meta name="description" content="FitBalance — калькулятор калорий, рекомендации по тренировкам, статистика питания. Поддержка Telegram WebApp." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            brand: {
              50: '#fff8f1', 100: '#fde9d7', 200: '#f9d2ae', 300: '#f4b781', 400: '#ef9957', 500: '#ea7a2c', 600: '#cd6120', 700: '#a64a19', 800: '#7f3713', 900: '#5e290f'
            },
            ink: '#0b0f14',
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.12)',
            glow: '0 0 0 6px rgba(234,122,44,.12)'
          },
          animation: {
            fade: 'fade .4s ease both',
          },
          keyframes: {
            fade: { '0%': { opacity: 0, transform: 'translateY(4px)' }, '100%': { opacity: 1, transform: 'none' } }
          }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; background: radial-gradient(1200px 600px at 10% -10%, #fef3e7, transparent), radial-gradient(900px 500px at 90% -20%, #ffe8d6, transparent), #0b0f14; }
    .glass { backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border: 1px solid rgba(255,255,255,.12); }
    .elev { box-shadow: 0 15px 40px rgba(0,0,0,.25); }
    .tab-active { color: white; }
    .hide { display: none; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="font-sans text-white/90 antialiased">
  <!-- Topbar -->
  <header class="max-w-6xl mx-auto px-4 pt-6">
    <div class="glass elev rounded-2xl p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-xl bg-brand-500 grid place-items-center shadow-glow">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 4h10a2 2 0 0 1 2 2v3a7 7 0 1 1-14 0V6a2 2 0 0 1 2-2Z" stroke="#fff" stroke-width="1.5"/>
            <path d="M9 18h6" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="text-lg font-semibold">FitBalance</div>
          <div class="text-xs text-white/60" id="hello">Здравствуйте</div>
        </div>
      </div>
      <div class="text-sm text-white/70" id="goalBadge">Цель: —</div>
    </div>
  </header>

  <!-- Main cards -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6">
    <!-- Energy card -->
    <section class="glass elev rounded-2xl p-5 animate-fade" id="energyCard">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-semibold mb-1">Сегодняшний баланс</h2>
          <p class="text-sm text-white/70">Калории за день и лимит по цели.</p>
        </div>
        <div class="text-right">
          <div class="text-3xl font-bold" id="kcalRemain">— ккал</div>
          <div class="text-xs text-white/60">осталось из <span id="kcalLimit">—</span> ккал</div>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">Съедено</div>
          <div class="text-2xl font-semibold" id="kcalEaten">0</div>
        </div>
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">Тренировка (расход)</div>
          <div class="text-2xl font-semibold" id="kcalBurned">0</div>
        </div>
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">Итог</div>
          <div class="text-2xl font-semibold" id="kcalNet">0</div>
        </div>
      </div>
    </section>

    <!-- Tabs content -->
    <section class="glass elev rounded-2xl overflow-hidden animate-fade">
      <!-- Tabs -->
      <nav class="grid grid-cols-3 bg-white/5">
        <button class="tab-btn py-3 text-center font-medium tab-active" data-tab="food">График питания</button>
        <button class="tab-btn py-3 text-center font-medium" data-tab="workouts">График тренировок</button>
        <button class="tab-btn py-3 text-center font-medium" data-tab="profile">Профиль</button>
      </nav>

      <!-- Food tab -->
      <div id="tab-food" class="p-5 grid gap-5">
        <div class="grid md:grid-cols-[1.2fr_.8fr] gap-4">
          <div class="rounded-xl bg-white/5 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <h3 class="font-semibold">Добавить продукт</h3>
              <button id="scanOpenFoodFacts" class="text-xs underline text-white/70">Поиск в интернете*</button>
            </div>
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">Продукт</label>
                <input id="foodName" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="например, куриная грудка" />
              </div>
              <div>
                <label class="text-xs text-white/70">Граммы</label>
                <input id="foodGrams" type="number" min="1" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="100" />
              </div>
              <div class="sm:col-span-2 grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-white/70">Или выберите из базы</label>
                  <select id="foodSelect" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10"></select>
                </div>
                <button id="addFood" class="mt-6 sm:mt-auto bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">Добавить</button>
              </div>
            </div>
            <p class="text-[11px] text-white/50 mt-2">*Запрос уходит в OpenFoodFacts; если нет ответа, используется локальная база.</p>
          </div>

          <div class="rounded-xl bg-white/5 p-4">
            <h3 class="font-semibold mb-2">Сколько можно съесть?</h3>
            <div class="grid gap-2">
              <input id="wishFood" class="w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="например, шоколад" />
              <div class="grid grid-cols-2 gap-2">
                <input id="wishKcalPer100" type="number" class="w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="ккал/100г (если знаете)" />
                <button id="calcWish" class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-3">Рассчитать граммы</button>
              </div>
              <div class="text-sm text-white/80" id="wishResult">—</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl bg-white/5 p-4">
          <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">Сегодняшние приёмы пищи</h3>
            <button id="clearToday" class="text-xs text-red-300">Очистить день</button></div>
          <div id="meals" class="grid gap-2"></div>
        </div>
      </div>

      <!-- Workouts tab -->
      <div id="tab-workouts" class="p-5 grid gap-5 hide">
        <div class="rounded-xl bg-white/5 p-4">
          <div class="flex items-center justify-between gap-3 mb-3">
            <h3 class="font-semibold">Программа тренировки</h3>
            <div class="text-xs text-white/70">Расположение: <span id="locLabel">—</span></div>
          </div>
          <div id="workoutPlan" class="grid md:grid-cols-2 gap-3"></div>
          <p class="text-[11px] text-white/50 mt-2">Ссылки «Видео» открывают поиск YouTube по упражнению.</p>
        </div>
        <div class="rounded-xl bg-white/5 p-4 grid sm:grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-white/70">Минут тренировки</label>
            <input id="mins" type="number" min="0" class="mt-1 w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="30" />
          </div>
          <div>
            <label class="text-xs text-white/70">Интенсивность</label>
            <select id="intensity" class="mt-1 w-full p-3 rounded-xl bg-white/5 border border-white/10">
              <option value="light">Лёгкая</option>
              <option value="moderate">Средняя</option>
              <option value="vigorous">Высокая</option>
            </select>
          </div>
          <button id="addBurn" class="sm:self-end bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">Добавить расход</button>
        </div>
        <div id="burnLog" class="rounded-xl bg-white/5 p-4 grid gap-2"></div>
      </div>

      <!-- Profile tab -->
      <div id="tab-profile" class="p-5 grid gap-5 hide">
        <div class="rounded-xl bg-white/5 p-4 grid md:grid-cols-2 gap-4">
          <div class="grid gap-2">
            <h3 class="font-semibold mb-1">Параметры</h3>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">Пол</label>
                <select id="gender" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="male">Мужчина</option>
                  <option value="female">Женщина</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/70">Возраст</label>
                <input id="age" type="number" min="10" max="100" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="28" />
              </div>
              <div>
                <label class="text-xs text-white/70">Рост (см)</label>
                <input id="height" type="number" min="120" max="230" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="175" />
              </div>
              <div>
                <label class="text-xs text-white/70">Вес (кг)</label>
                <input id="weight" type="number" min="30" max="250" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="75" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">Цель</label>
                <select id="goal" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="lose">Похудеть</option>
                  <option value="maintain">Поддерживать</option>
                  <option value="gain">Набрать массу</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/70">Где тренируетесь?</label>
                <select id="location" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="home">Дома</option>
                  <option value="gym">В зале</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-xs text-white/70">Активность</label>
              <select id="activity" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                <option value="1.2">Минимальная</option>
                <option value="1.375">Лёгкая (1–3 трен/нед)</option>
                <option value="1.55">Средняя (3–5)</option>
                <option value="1.725">Высокая (6+)</option>
              </select>
            </div>
            <button id="saveProfile" class="mt-2 bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">Сохранить профиль</button>
          </div>

          <div class="grid gap-2">
            <h3 class="font-semibold mb-1">Ваши расчёты</h3>
            <div class="rounded-xl bg-white/5 p-4 grid gap-2 text-sm">
              <div>Базовый метаболизм (Миффлин—Сан Жеор): <span id="bmr">—</span> ккал</div>
              <div>Поддержание (TDEE): <span id="tdee">—</span> ккал</div>
              <div>Дневной лимит по цели: <span id="limit">—</span> ккал</div>
              <div>Макро ориентиры: <span id="macros">—</span></div>
            </div>
            <div class="rounded-xl bg-white/5 p-4">
              <h4 class="font-semibold mb-2">Экспорт / Импорт</h4>
              <div class="grid sm:grid-cols-2 gap-2">
                <button id="exportBtn" class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-2">Экспорт JSON</button>
                <label class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-2 text-center cursor-pointer">
                  Импорт JSON <input type="file" id="importFile" accept="application/json" class="hidden" />
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl overflow-hidden">
          <table class="w-full text-sm">
            <thead class="bg-white/10">
              <tr><th class="text-left p-3">Дата</th><th class="text-left p-3">Ккал</th><th class="text-left p-3">Белки</th><th class="text-left p-3">Жиры</th><th class="text-left p-3">Углеводы</th></tr>
            </thead>
            <tbody id="history" class="bg-white/5"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav (sticky on mobile) -->
  <footer class="fixed bottom-0 inset-x-0 md:static md:max-w-6xl md:mx-auto md:px-4 md:pb-6">
    <div class="m-3 md:m-0 glass elev rounded-2xl grid grid-cols-3 overflow-hidden">
      <button class="py-3 text-center tab-btn tab-active" data-tab="food">🍽️ Питание</button>
      <button class="py-3 text-center tab-btn" data-tab="workouts">🏋️ Тренировки</button>
      <button class="py-3 text-center tab-btn" data-tab="profile">👤 Профиль</button>
    </div>
  </footer>

  <script>
    // ======= Data (tiny local food DB as fallback) =======
    const LOCAL_DB = [
      { name: 'Куриная грудка варёная', kcal: 165, protein: 31, fat: 3.6, carbs: 0 },
      { name: 'Рис белый варёный', kcal: 130, protein: 2.7, fat: 0.3, carbs: 28 },
      { name: 'Гречка варёная', kcal: 110, protein: 4.5, fat: 1.3, carbs: 20 },
      { name: 'Яйцо куриное', kcal: 155, protein: 13, fat: 11, carbs: 1.1 },
      { name: 'Творог 5%', kcal: 121, protein: 17, fat: 5, carbs: 2.7 },
      { name: 'Овсянка на воде', kcal: 71, protein: 2.5, fat: 1.5, carbs: 12 },
      { name: 'Авокадо', kcal: 160, protein: 2, fat: 15, carbs: 9 },
      { name: 'Яблоко', kcal: 52, protein: 0.3, fat: 0.2, carbs: 14 },
      { name: 'Банан', kcal: 89, protein: 1.1, fat: 0.3, carbs: 23 },
      { name: 'Говядина постная', kcal: 187, protein: 26, fat: 9, carbs: 0 },
      { name: 'Лосось', kcal: 208, protein: 20, fat: 13, carbs: 0 },
      { name: 'Творог зернёный', kcal: 98, protein: 11, fat: 4.3, carbs: 3.4 },
      { name: 'Сыр творожный', kcal: 250, protein: 9, fat: 24, carbs: 3 },
      { name: 'Шоколад тёмный 70%', kcal: 600, protein: 7.8, fat: 43, carbs: 46 },
    ];

    const EXERCISES = {
      home: {
        lose: [
          { muscle: 'Ноги/ягодицы', name: 'Приседания с весом своего тела', sets: '3×15', note: 'Контроль темпа' },
          { muscle: 'Грудь/плечи/трицепс', name: 'Отжимания от пола', sets: '3×10–15', note: 'Колени при необходимости' },
          { muscle: 'Спина/кор', name: 'Планка', sets: '3×40–60 сек', note: 'Живот в тонусе' },
          { muscle: 'Кардио', name: 'Скакалка или быстрые шаги на месте', sets: '10–20 мин', note: 'Пульс 60–70% МЧС' },
        ],
        maintain: [
          { muscle: 'Ноги', name: 'Выпады вперёд', sets: '3×12/нога', note: '' },
          { muscle: 'Спина', name: 'Тяга эластичной ленты', sets: '3×12–15', note: 'Сводим лопатки' },
          { muscle: 'Пресс', name: 'Скручивания', sets: '3×20', note: '' },
          { muscle: 'Кардио', name: 'Чередование бег/ходьба', sets: '20 мин', note: '' },
        ],
        gain: [
          { muscle: 'Грудь', name: 'Отжимания с узкой постановкой', sets: '4×10–12', note: 'Медленный негатив' },
          { muscle: 'Ноги', name: 'Болгарские сплит-приседания', sets: '4×10/нога', note: '' },
          { muscle: 'Спина', name: 'Подтягивания/автоподтягивания', sets: '4×макс', note: 'Резинка при необходимости' },
          { muscle: 'Плечи', name: 'Жим гантелей вверх (домашние)', sets: '4×12', note: '' },
        ]
      },
      gym: {
        lose: [
          { muscle: 'Ноги', name: 'Жим ногами', sets: '4×12–15', note: '' },
          { muscle: 'Грудь', name: 'Жим лёжа', sets: '4×8–10', note: '' },
          { muscle: 'Спина', name: 'Тяга верхнего блока', sets: '4×10–12', note: '' },
          { muscle: 'Кардио', name: 'Эллипсоид', sets: '20–30 мин', note: '60–70% МЧС' },
        ],
        maintain: [
          { muscle: 'Плечи', name: 'Жим гантелей сидя', sets: '3×10–12', note: '' },
          { muscle: 'Спина', name: 'Тяга горизонтального блока', sets: '3×10–12', note: '' },
          { muscle: 'Пресс', name: 'Подъём колен в висе', sets: '3×12–15', note: '' },
          { muscle: 'Ноги', name: 'Разгибания ног в тренажёре', sets: '3×12–15', note: '' },
        ],
        gain: [
          { muscle: 'Грудь', name: 'Жим штанги лёжа', sets: '5×5–8', note: 'Прогрессия нагрузки' },
          { muscle: 'Спина', name: 'Тяга штанги в наклоне', sets: '5×5–8', note: '' },
          { muscle: 'Ноги', name: 'Приседания со штангой', sets: '5×5', note: '' },
          { muscle: 'Плечи', name: 'Жим штанги стоя', sets: '4×6–8', note: '' },
        ]
      }
    };

    // ======= State & Storage =======
    const tg = window.Telegram?.WebApp;
    let UID = 'anon';
    if (tg && tg.initDataUnsafe?.user) {
      UID = String(tg.initDataUnsafe.user.id);
      tg.expand();
      document.getElementById('hello').textContent = `Привет, ${tg.initDataUnsafe.user.first_name || 'друг'}!`;
      tg.MainButton.setParams({ text: 'Сохранить профиль', is_visible: false });
      tg.onEvent('mainButtonClicked', () => document.getElementById('saveProfile').click());
      document.body.style.background = tg.colorScheme === 'dark' ? '#0b0f14' : '#0b0f14';
    }

    const storeKey = (k) => `fitbalance:${UID}:${k}`;
    const read = (k, v=null) => { try { return JSON.parse(localStorage.getItem(storeKey(k))) ?? v } catch { return v } };
    const write = (k, v) => localStorage.setItem(storeKey(k), JSON.stringify(v));

    const state = {
      profile: read('profile', { gender: 'male', age: 28, height: 175, weight: 75, goal: 'maintain', activity: 1.375, location: 'home' }),
      meals: read('meals', {}), // map date -> [items]
      burns: read('burns', {}), // map date -> [items]
      kcalLimit: 0,
    };

    const todayKey = () => new Date().toISOString().slice(0,10);

    // ======= Helpers =======
    function fmt(n) { return Math.round(n); }
    function calcBMR({ gender, age, height, weight }) {
      // Mifflin–St Jeor
      return gender === 'male' ? 10*weight + 6.25*height - 5*age + 5 : 10*weight + 6.25*height - 5*age - 161;
    }
    function goalOffset(goal) { return goal==='lose' ? -400 : goal==='gain' ? 300 : 0 } // спокойные рекомендации
    function macroTargets(weight, goal) {
      const p = goal==='gain' ? 1.8 : goal==='lose' ? 1.6 : 1.6; // g/kg
      const fat = 0.8; // g/kg
      return { protein: fmt(weight*p), fat: fmt(weight*fat) };
    }

    function foodsToOptions() {
      const sel = document.getElementById('foodSelect');
      sel.innerHTML = '<option value="">— выбрать продукт —</option>' + LOCAL_DB.map((f,i)=>`<option value="${i}">${f.name} — ${f.kcal} ккал/100г</option>`).join('');
    }

    function addMealItem(name, grams, per100) {
      const d = todayKey();
      const list = state.meals[d] || (state.meals[d] = []);
      const factor = grams/100;
      const item = {
        name, grams,
        kcal: per100.kcal*factor,
        protein: (per100.protein||0)*factor,
        fat: (per100.fat||0)*factor,
        carbs: (per100.carbs||0)*factor,
      };
      list.push(item); write('meals', state.meals); renderMeals(); renderEnergy();
    }

    function addBurnItem(mins, intensity) {
      const d = todayKey();
      const list = state.burns[d] || (state.burns[d] = []);
      const met = intensity==='light' ? 4 : intensity==='moderate' ? 6 : 8; // условный MET
      const kcal = (met * state.profile.weight * (mins/60));
      list.push({ mins, intensity, kcal }); write('burns', state.burns); renderBurns(); renderEnergy();
    }

    function sumDay(items) { return items?.reduce((a,b)=>a+b.kcal,0)||0 }
    function sumMacros(items, k) { return items?.reduce((a,b)=>a+(b[k]||0),0)||0 }

    function renderMeals() {
      const d = todayKey();
      const box = document.getElementById('meals'); box.innerHTML = '';
      const items = state.meals[d]||[];
      if (!items.length) { box.innerHTML = '<div class="text-white/60 text-sm">Нет записей. Добавьте продукт.</div>'; return }
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-white/5 rounded-xl p-3';
        row.innerHTML = `<div><div class="font-medium">${it.name}</div><div class="text-xs text-white/60">${fmt(it.grams)} г • ${fmt(it.kcal)} ккал • Б:${fmt(it.protein)} Ж:${fmt(it.fat)} У:${fmt(it.carbs)}</div></div>
        <button class="text-xs text-red-300" data-i="${idx}">Удалить</button>`;
        row.querySelector('button').onclick = (e)=>{ (state.meals[d]||[]).splice(Number(e.target.dataset.i),1); write('meals', state.meals); renderMeals(); renderEnergy(); };
        box.appendChild(row);
      })
    }

    function renderBurns() {
      const d = todayKey();
      const box = document.getElementById('burnLog'); box.innerHTML = '';
      const items = state.burns[d]||[];
      if (!items.length) { box.innerHTML = '<div class="text-white/60 text-sm">Нет записей тренировки за сегодня.</div>'; return }
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-white/5 rounded-xl p-3';
        row.innerHTML = `<div><div class="font-medium">${it.intensity} • ${fmt(it.mins)} мин</div><div class="text-xs text-white/60">~ ${fmt(it.kcal)} ккал</div></div>
        <button class="text-xs text-red-300" data-i="${idx}">Удалить</button>`;
        row.querySelector('button').onclick = (e)=>{ (state.burns[d]||[]).splice(Number(e.target.dataset.i),1); write('burns', state.burns); renderBurns(); renderEnergy(); };
        box.appendChild(row);
      })
    }

    function renderEnergy() {
      const prof = state.profile;
      const bmr = calcBMR(prof), tdee = bmr * Number(prof.activity);
      const limit = tdee + goalOffset(prof.goal);
      state.kcalLimit = limit; document.getElementById('kcalLimit').textContent = fmt(limit);
      const eaten = sumDay(state.meals[todayKey()]);
      const burned = sumDay(state.burns[todayKey()]);
      const net = eaten - burned;
      const remain = Math.max(0, limit - net);
      document.getElementById('kcalEaten').textContent = fmt(eaten);
      document.getElementById('kcalBurned').textContent = fmt(burned);
      document.getElementById('kcalNet').textContent = fmt(net);
      document.getElementById('kcalRemain').textContent = `${fmt(remain)} ккал`;
      document.getElementById('goalBadge').textContent = `Цель: ${prof.goal==='lose'?'Похудение':prof.goal==='gain'?'Масса':'Поддержание'}`;
      // update wish helper
      const per100 = Number(document.getElementById('wishKcalPer100').value||0);
      if (per100>0) {
        const grams = Math.max(0, Math.floor((remain / per100) * 100));
        document.getElementById('wishResult').textContent = grams?`Можно ~ ${grams} г, чтобы не превысить лимит.`:'—';
      }
      renderHistory();
      renderWorkoutPlan();
    }

    function renderProfile() {
      const p = state.profile;
      document.getElementById('gender').value = p.gender;
      document.getElementById('age').value = p.age;
      document.getElementById('height').value = p.height;
      document.getElementById('weight').value = p.weight;
      document.getElementById('goal').value = p.goal;
      document.getElementById('activity').value = String(p.activity);
      document.getElementById('location').value = p.location;

      const bmr = calcBMR(p);
      const tdee = bmr * Number(p.activity);
      const limit = tdee + goalOffset(p.goal);
      const macros = macroTargets(p.weight, p.goal);
      const carbs = Math.max(0, Math.round((limit - (macros.protein*4 + macros.fat*9))/4));
      document.getElementById('bmr').textContent = fmt(bmr);
      document.getElementById('tdee').textContent = fmt(tdee);
      document.getElementById('limit').textContent = fmt(limit);
      document.getElementById('macros').textContent = `Б:${macros.protein}г Ж:${macros.fat}г У:${carbs}г (ориентир)`;
      document.getElementById('locLabel').textContent = p.location==='gym'?'зал':'дом';
    }

    function renderHistory() {
      const tbody = document.getElementById('history'); tbody.innerHTML = '';
      const days = Object.keys(state.meals).sort().slice(-14); // последние 14 дней
      days.forEach(d=>{
        const meals = state.meals[d]||[];
        const burns = state.burns[d]||[];
        const kcal = (meals.reduce((a,b)=>a+b.kcal,0) - burns.reduce((a,b)=>a+b.kcal,0));
        const p = meals.reduce((a,b)=>a+(b.protein||0),0);
        const f = meals.reduce((a,b)=>a+(b.fat||0),0);
        const c = meals.reduce((a,b)=>a+(b.carbs||0),0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-3 text-white/80">${d}</td><td class="p-3">${fmt(kcal)}</td><td class="p-3">${fmt(p)}</td><td class="p-3">${fmt(f)}</td><td class="p-3">${fmt(c)}</td>`;
        tbody.appendChild(tr);
      })
    }

    function renderWorkoutPlan() {
      const wrap = document.getElementById('workoutPlan');
      wrap.innerHTML = '';
      const list = EXERCISES[state.profile.location][state.profile.goal];
      list.forEach(ex => {
        const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(ex.name + ' техника выполнения')}`;
        const card = document.createElement('div');
        card.className = 'bg-white/5 rounded-xl p-4';
        card.innerHTML = `<div class="text-xs text-white/60">${ex.muscle}</div>
          <div class="font-semibold">${ex.name}</div>
          <div class="text-sm text-white/70">${ex.sets} ${ex.note?('• '+ex.note):''}</div>
          <a class="inline-block mt-2 text-brand-300 underline" href="${url}" target="_blank" rel="noopener">Видео</a>`;
        wrap.appendChild(card);
      })
    }

    // ======= Internet providers =======
    async function searchOpenFoodFacts(q) {
      try {
        const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&json=1&page_size=1`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('http');
        const data = await res.json();
        const p = data.products?.[0];
        if (!p) return null;
        const nutr = p.nutriments || {};
        const per100 = {
          kcal: nutr['energy-kcal_100g'] ?? nutr['energy-kcal'] ?? (nutr['energy_100g']? nutr['energy_100g']/4.184 : null),
          protein: nutr['proteins_100g'] ?? 0,
          fat: nutr['fat_100g'] ?? 0,
          carbs: nutr['carbohydrates_100g'] ?? 0,
        };
        if (!per100.kcal) return null;
        return { name: p.product_name || q, per100 };
      } catch (e) { return null }
    }

    // ======= Events =======
    document.addEventListener('DOMContentLoaded', () => {
      foodsToOptions();
      renderProfile();
      renderMeals();
      renderBurns();
      renderEnergy();

      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
          btn.classList.add('tab-active');
          const t = btn.dataset.tab;
          document.getElementById('tab-food').classList.toggle('hide', t!=='food');
          document.getElementById('tab-workouts').classList.toggle('hide', t!=='workouts');
          document.getElementById('tab-profile').classList.toggle('hide', t!=='profile');
        })
      })

      document.getElementById('foodSelect').addEventListener('change', e=>{
        const i = e.target.value; if (i==='') return;
        const f = LOCAL_DB[Number(i)];
        document.getElementById('foodName').value = f.name;
        document.getElementById('foodGrams').value = 100;
      })

      document.getElementById('addFood').addEventListener('click', ()=>{
        const name = document.getElementById('foodName').value.trim();
        let grams = Number(document.getElementById('foodGrams').value);
        if (!name || !grams) return alert('Укажите продукт и граммы');
        // try to resolve per100 from local DB first
        let per100 = LOCAL_DB.find(f=>f.name.toLowerCase()===name.toLowerCase());
        if (!per100) {
          // heuristic: if selection chosen but edited name, try selected index
          const sel = document.getElementById('foodSelect');
          if (sel.value!=='') per100 = LOCAL_DB[Number(sel.value)];
        }
        if (!per100) { per100 = { kcal: 100, protein: 0, fat: 0, carbs: 0 }; }
        addMealItem(name, grams, per100);
        document.getElementById('foodName').value='';
        document.getElementById('foodGrams').value='';
        document.getElementById('foodSelect').value='';
      })

      document.getElementById('clearToday').addEventListener('click', ()=>{
        if (!confirm('Очистить сегодняшние записи?')) return;
        state.meals[todayKey()] = []; write('meals', state.meals); renderMeals(); renderEnergy();
      })

      document.getElementById('calcWish').addEventListener('click', ()=>{
        const per100 = Number(document.getElementById('wishKcalPer100').value||0);
        if (!per100) { alert('Укажите ккал/100г для оценки'); return }
        const remain = Math.max(0, state.kcalLimit - (sumDay(state.meals[todayKey()]) - sumDay(state.burns[todayKey()])));
        const grams = Math.max(0, Math.floor((remain / per100) * 100));
        document.getElementById('wishResult').textContent = grams?`Можно ~ ${grams} г, чтобы не превысить лимит.`:'—';
      })

      document.getElementById('addBurn').addEventListener('click', ()=>{
        const mins = Number(document.getElementById('mins').value||0);
        const intensity = document.getElementById('intensity').value;
        if (!mins) return alert('Укажите минуты');
        addBurnItem(mins, intensity);
        document.getElementById('mins').value='';
      })

      document.getElementById('saveProfile').addEventListener('click', ()=>{
        state.profile = {
          gender: document.getElementById('gender').value,
          age: Number(document.getElementById('age').value||28),
          height: Number(document.getElementById('height').value||175),
          weight: Number(document.getElementById('weight').value||75),
          goal: document.getElementById('goal').value,
          activity: Number(document.getElementById('activity').value),
          location: document.getElementById('location').value,
        };
        write('profile', state.profile);
        if (tg) { tg.HapticFeedback.impactOccurred('light'); tg.showAlert('Профиль сохранён'); }
        renderProfile(); renderEnergy();
      })

      document.getElementById('scanOpenFoodFacts').addEventListener('click', async ()=>{
        const q = prompt('Что ищем?'); if (!q) return;
        const res = await searchOpenFoodFacts(q);
        if (!res) { alert('Не найдено. Используйте локальную базу или введите ккал/100г вручную.'); return }
        document.getElementById('foodName').value = res.name;
        document.getElementById('foodGrams').value = 100;
        alert(`${res.name}: ~${Math.round(res.per100.kcal)} ккал/100г`);
      })

      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const data = { profile: state.profile, meals: state.meals, burns: state.burns };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `fitbalance-${UID}-${todayKey()}.json`; a.click();
      })
      document.getElementById('importFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        const text = await file.text();
        try { const data = JSON.parse(text); if (data.profile) state.profile = data.profile; if (data.meals) state.meals = data.meals; if (data.burns) state.burns = data.burns; write('profile', state.profile); write('meals', state.meals); write('burns', state.burns); renderProfile(); renderMeals(); renderBurns(); renderEnergy(); alert('Импортировано'); } catch { alert('Ошибка импорта'); }
      })
    });
  </script>
</body>
</html>
