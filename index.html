<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FitBalance ‚Äî –ø–∏—Ç–∞–Ω–∏–µ, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –ø—Ä–æ—Ñ–∏–ª—å</title>
  <meta name="description" content="FitBalance ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∏—Ç–∞–Ω–∏—è. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram WebApp." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            brand: {
              50: '#fff8f1', 100: '#fde9d7', 200: '#f9d2ae', 300: '#f4b781', 400: '#ef9957', 500: '#ea7a2c', 600: '#cd6120', 700: '#a64a19', 800: '#7f3713', 900: '#5e290f'
            },
            ink: '#0b0f14',
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.12)',
            glow: '0 0 0 6px rgba(234,122,44,.12)'
          },
          animation: {
            fade: 'fade .4s ease both',
          },
          keyframes: {
            fade: { '0%': { opacity: 0, transform: 'translateY(4px)' }, '100%': { opacity: 1, transform: 'none' } }
          }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; background: radial-gradient(1200px 600px at 10% -10%, #fef3e7, transparent), radial-gradient(900px 500px at 90% -20%, #ffe8d6, transparent), #0b0f14; }
    .glass { backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border: 1px solid rgba(255,255,255,.12); }
    .elev { box-shadow: 0 15px 40px rgba(0,0,0,.25); }
    .tab-active { color: white; }
    .hide { display: none; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="font-sans text-white/90 antialiased">
  <!-- Topbar -->
  <header class="max-w-6xl mx-auto px-4 pt-6">
    <div class="glass elev rounded-2xl p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-xl bg-brand-500 grid place-items-center shadow-glow">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 4h10a2 2 0 0 1 2 2v3a7 7 0 1 1-14 0V6a2 2 0 0 1 2-2Z" stroke="#fff" stroke-width="1.5"/>
            <path d="M9 18h6" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="text-lg font-semibold">FitBalance</div>
          <div class="text-xs text-white/60" id="hello">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ</div>
        </div>
      </div>
      <div class="text-sm text-white/70" id="goalBadge">–¶–µ–ª—å: ‚Äî</div>
    </div>
  </header>

  <!-- Main cards -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-6">
    <!-- Energy card -->
    <section class="glass elev rounded-2xl p-5 animate-fade" id="energyCard">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-semibold mb-1">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –±–∞–ª–∞–Ω—Å</h2>
          <p class="text-sm text-white/70">–ö–∞–ª–æ—Ä–∏–∏ –∑–∞ –¥–µ–Ω—å –∏ –ª–∏–º–∏—Ç –ø–æ —Ü–µ–ª–∏.</p>
        </div>
        <div class="text-right">
          <div class="text-3xl font-bold" id="kcalRemain">‚Äî –∫–∫–∞–ª</div>
          <div class="text-xs text-white/60">–æ—Å—Ç–∞–ª–æ—Å—å –∏–∑ <span id="kcalLimit">‚Äî</span> –∫–∫–∞–ª</div>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">–°—ä–µ–¥–µ–Ω–æ</div>
          <div class="text-2xl font-semibold" id="kcalEaten">0</div>
        </div>
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (—Ä–∞—Å—Ö–æ–¥)</div>
          <div class="text-2xl font-semibold" id="kcalBurned">0</div>
        </div>
        <div class="rounded-xl bg-white/5 p-4">
          <div class="text-sm text-white/70">–ò—Ç–æ–≥</div>
          <div class="text-2xl font-semibold" id="kcalNet">0</div>
        </div>
      </div>
    </section>

    <!-- Tabs content -->
    <section class="glass elev rounded-2xl overflow-hidden animate-fade">
      <!-- Tabs -->
      <nav class="grid grid-cols-3 bg-white/5">
        <button class="tab-btn py-3 text-center font-medium tab-active" data-tab="food">–ì—Ä–∞—Ñ–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</button>
        <button class="tab-btn py-3 text-center font-medium" data-tab="workouts">–ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</button>
        <button class="tab-btn py-3 text-center font-medium" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
      </nav>

      <!-- Food tab -->
      <div id="tab-food" class="p-5 grid gap-5">
        <div class="grid md:grid-cols-[1.2fr_.8fr] gap-4">
          <div class="rounded-xl bg-white/5 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <h3 class="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h3>
              <button id="scanOpenFoodFacts" class="text-xs underline text-white/70">–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ*</button>
            </div>
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">–ü—Ä–æ–¥—É–∫—Ç</label>
                <input id="foodName" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞" />
              </div>
              <div>
                <label class="text-xs text-white/70">–ì—Ä–∞–º–º—ã</label>
                <input id="foodGrams" type="number" min="1" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="100" />
              </div>
              <div class="sm:col-span-2 grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-white/70">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –±–∞–∑—ã</label>
                  <select id="foodSelect" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10"></select>
                </div>
                <button id="addFood" class="mt-6 sm:mt-auto bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
            <p class="text-[11px] text-white/50 mt-2">*–ó–∞–ø—Ä–æ—Å —É—Ö–æ–¥–∏—Ç –≤ OpenFoodFacts; –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞.</p>
          </div>

          <div class="rounded-xl bg-white/5 p-4">
            <h3 class="font-semibold mb-2">–°–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ —Å—ä–µ—Å—Ç—å?</h3>
            <div class="grid gap-2">
              <input id="wishFood" class="w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —à–æ–∫–æ–ª–∞–¥" />
              <div class="grid grid-cols-2 gap-2">
                <input id="wishKcalPer100" type="number" class="w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="–∫–∫–∞–ª/100–≥ (–µ—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ)" />
                <button id="calcWish" class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-3">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≥—Ä–∞–º–º—ã</button>
              </div>
              <div class="text-sm text-white/80" id="wishResult">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="rounded-xl bg-white/5 p-4">
          <div class="flex items-center justify-between mb-2"><h3 class="font-semibold">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h3>
            <button id="clearToday" class="text-xs text-red-300">–û—á–∏—Å—Ç–∏—Ç—å –¥–µ–Ω—å</button></div>
          <div id="meals" class="grid gap-2"></div>
        </div>
      </div>

      <!-- Workouts tab -->
      <div id="tab-workouts" class="p-5 grid gap-5 hide">
        <div class="rounded-xl bg-white/5 p-4">
          <div class="flex items-center justify-between gap-3 mb-3">
            <h3 class="font-semibold">–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
            <div class="text-xs text-white/70">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: <span id="locLabel">‚Äî</span></div>
          </div>
          <div id="workoutPlan" class="grid md:grid-cols-2 gap-3"></div>
          <p class="text-[11px] text-white/50 mt-2">–°—Å—ã–ª–∫–∏ ¬´–í–∏–¥–µ–æ¬ª –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –ø–æ–∏—Å–∫ YouTube –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é.</p>
        </div>
        <div class="rounded-xl bg-white/5 p-4 grid sm:grid-cols-3 gap-3">
          <div>
            <label class="text-xs text-white/70">–ú–∏–Ω—É—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</label>
            <input id="mins" type="number" min="0" class="mt-1 w-full p-3 rounded-xl bg-white/5 border border-white/10" placeholder="30" />
          </div>
          <div>
            <label class="text-xs text-white/70">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
            <select id="intensity" class="mt-1 w-full p-3 rounded-xl bg-white/5 border border-white/10">
              <option value="light">–õ—ë–≥–∫–∞—è</option>
              <option value="moderate">–°—Ä–µ–¥–Ω—è—è</option>
              <option value="vigorous">–í—ã—Å–æ–∫–∞—è</option>
            </select>
          </div>
          <button id="addBurn" class="sm:self-end bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        </div>
        <div id="burnLog" class="rounded-xl bg-white/5 p-4 grid gap-2"></div>
      </div>

      <!-- Profile tab -->
      <div id="tab-profile" class="p-5 grid gap-5 hide">
        <div class="rounded-xl bg-white/5 p-4 grid md:grid-cols-2 gap-4">
          <div class="grid gap-2">
            <h3 class="font-semibold mb-1">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">–ü–æ–ª</label>
                <select id="gender" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
                  <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/70">–í–æ–∑—Ä–∞—Å—Ç</label>
                <input id="age" type="number" min="10" max="100" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="28" />
              </div>
              <div>
                <label class="text-xs text-white/70">–†–æ—Å—Ç (—Å–º)</label>
                <input id="height" type="number" min="120" max="230" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="175" />
              </div>
              <div>
                <label class="text-xs text-white/70">–í–µ—Å (–∫–≥)</label>
                <input id="weight" type="number" min="30" max="250" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10" placeholder="75" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-white/70">–¶–µ–ª—å</label>
                <select id="goal" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="lose">–ü–æ—Ö—É–¥–µ—Ç—å</option>
                  <option value="maintain">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å</option>
                  <option value="gain">–ù–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-white/70">–ì–¥–µ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç–µ—Å—å?</label>
                <select id="location" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                  <option value="home">–î–æ–º–∞</option>
                  <option value="gym">–í –∑–∞–ª–µ</option>
                </select>
              </div>
            </div>
            <div>
              <label class="text-xs text-white/70">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
              <select id="activity" class="w-full mt-1 p-3 rounded-xl bg-white/5 border border-white/10">
                <option value="1.2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è</option>
                <option value="1.375">–õ—ë–≥–∫–∞—è (1‚Äì3 —Ç—Ä–µ–Ω/–Ω–µ–¥)</option>
                <option value="1.55">–°—Ä–µ–¥–Ω—è—è (3‚Äì5)</option>
                <option value="1.725">–í—ã—Å–æ–∫–∞—è (6+)</option>
              </select>
            </div>
            <button id="saveProfile" class="mt-2 bg-brand-500 hover:bg-brand-400 transition rounded-xl px-4 py-3 font-semibold shadow-glow">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>

          <div class="grid gap-2">
            <h3 class="font-semibold mb-1">–í–∞—à–∏ —Ä–∞—Å—á—ë—Ç—ã</h3>
            <div class="rounded-xl bg-white/5 p-4 grid gap-2 text-sm">
              <div>–ë–∞–∑–æ–≤—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º (–ú–∏—Ñ—Ñ–ª–∏–Ω‚Äî–°–∞–Ω –ñ–µ–æ—Ä): <span id="bmr">‚Äî</span> –∫–∫–∞–ª</div>
              <div>–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ (TDEE): <span id="tdee">‚Äî</span> –∫–∫–∞–ª</div>
              <div>–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –ø–æ —Ü–µ–ª–∏: <span id="limit">‚Äî</span> –∫–∫–∞–ª</div>
              <div>–ú–∞–∫—Ä–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã: <span id="macros">‚Äî</span></div>
            </div>
            <div class="rounded-xl bg-white/5 p-4">
              <h4 class="font-semibold mb-2">–≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç</h4>
              <div class="grid sm:grid-cols-2 gap-2">
                <button id="exportBtn" class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-2">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                <label class="bg-white/10 hover:bg-white/20 rounded-xl px-4 py-2 text-center cursor-pointer">
                  –ò–º–ø–æ—Ä—Ç JSON <input type="file" id="importFile" accept="application/json" class="hidden" />
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-2xl overflow-hidden">
          <table class="w-full text-sm">
            <thead class="bg-white/10">
              <tr><th class="text-left p-3">–î–∞—Ç–∞</th><th class="text-left p-3">–ö–∫–∞–ª</th><th class="text-left p-3">–ë–µ–ª–∫–∏</th><th class="text-left p-3">–ñ–∏—Ä—ã</th><th class="text-left p-3">–£–≥–ª–µ–≤–æ–¥—ã</th></tr>
            </thead>
            <tbody id="history" class="bg-white/5"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom nav (sticky on mobile) -->
  <footer class="fixed bottom-0 inset-x-0 md:static md:max-w-6xl md:mx-auto md:px-4 md:pb-6">
    <div class="m-3 md:m-0 glass elev rounded-2xl grid grid-cols-3 overflow-hidden">
      <button class="py-3 text-center tab-btn tab-active" data-tab="food">üçΩÔ∏è –ü–∏—Ç–∞–Ω–∏–µ</button>
      <button class="py-3 text-center tab-btn" data-tab="workouts">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
      <button class="py-3 text-center tab-btn" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </footer>

  <script>
    // ======= Data (tiny local food DB as fallback) =======
    const LOCAL_DB = [
      { name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ –≤–∞—Ä—ë–Ω–∞—è', kcal: 165, protein: 31, fat: 3.6, carbs: 0 },
      { name: '–†–∏—Å –±–µ–ª—ã–π –≤–∞—Ä—ë–Ω—ã–π', kcal: 130, protein: 2.7, fat: 0.3, carbs: 28 },
      { name: '–ì—Ä–µ—á–∫–∞ –≤–∞—Ä—ë–Ω–∞—è', kcal: 110, protein: 4.5, fat: 1.3, carbs: 20 },
      { name: '–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ', kcal: 155, protein: 13, fat: 11, carbs: 1.1 },
      { name: '–¢–≤–æ—Ä–æ–≥ 5%', kcal: 121, protein: 17, fat: 5, carbs: 2.7 },
      { name: '–û–≤—Å—è–Ω–∫–∞ –Ω–∞ –≤–æ–¥–µ', kcal: 71, protein: 2.5, fat: 1.5, carbs: 12 },
      { name: '–ê–≤–æ–∫–∞–¥–æ', kcal: 160, protein: 2, fat: 15, carbs: 9 },
      { name: '–Ø–±–ª–æ–∫–æ', kcal: 52, protein: 0.3, fat: 0.2, carbs: 14 },
      { name: '–ë–∞–Ω–∞–Ω', kcal: 89, protein: 1.1, fat: 0.3, carbs: 23 },
      { name: '–ì–æ–≤—è–¥–∏–Ω–∞ –ø–æ—Å—Ç–Ω–∞—è', kcal: 187, protein: 26, fat: 9, carbs: 0 },
      { name: '–õ–æ—Å–æ—Å—å', kcal: 208, protein: 20, fat: 13, carbs: 0 },
      { name: '–¢–≤–æ—Ä–æ–≥ –∑–µ—Ä–Ω—ë–Ω—ã–π', kcal: 98, protein: 11, fat: 4.3, carbs: 3.4 },
      { name: '–°—ã—Ä —Ç–≤–æ—Ä–æ–∂–Ω—ã–π', kcal: 250, protein: 9, fat: 24, carbs: 3 },
      { name: '–®–æ–∫–æ–ª–∞–¥ —Ç—ë–º–Ω—ã–π 70%', kcal: 600, protein: 7.8, fat: 43, carbs: 46 },
    ];

    const EXERCISES = {
      home: {
        lose: [
          { muscle: '–ù–æ–≥–∏/—è–≥–æ–¥–∏—Ü—ã', name: '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å –≤–µ—Å–æ–º —Å–≤–æ–µ–≥–æ —Ç–µ–ª–∞', sets: '3√ó15', note: '–ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–∞' },
          { muscle: '–ì—Ä—É–¥—å/–ø–ª–µ—á–∏/—Ç—Ä–∏—Ü–µ–ø—Å', name: '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞', sets: '3√ó10‚Äì15', note: '–ö–æ–ª–µ–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏' },
          { muscle: '–°–ø–∏–Ω–∞/–∫–æ—Ä', name: '–ü–ª–∞–Ω–∫–∞', sets: '3√ó40‚Äì60 —Å–µ–∫', note: '–ñ–∏–≤–æ—Ç –≤ —Ç–æ–Ω—É—Å–µ' },
          { muscle: '–ö–∞—Ä–¥–∏–æ', name: '–°–∫–∞–∫–∞–ª–∫–∞ –∏–ª–∏ –±—ã—Å—Ç—Ä—ã–µ —à–∞–≥–∏ –Ω–∞ –º–µ—Å—Ç–µ', sets: '10‚Äì20 –º–∏–Ω', note: '–ü—É–ª—å—Å 60‚Äì70% –ú–ß–°' },
        ],
        maintain: [
          { muscle: '–ù–æ–≥–∏', name: '–í—ã–ø–∞–¥—ã –≤–ø–µ—Ä—ë–¥', sets: '3√ó12/–Ω–æ–≥–∞', note: '' },
          { muscle: '–°–ø–∏–Ω–∞', name: '–¢—è–≥–∞ —ç–ª–∞—Å—Ç–∏—á–Ω–æ–π –ª–µ–Ω—Ç—ã', sets: '3√ó12‚Äì15', note: '–°–≤–æ–¥–∏–º –ª–æ–ø–∞—Ç–∫–∏' },
          { muscle: '–ü—Ä–µ—Å—Å', name: '–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è', sets: '3√ó20', note: '' },
          { muscle: '–ö–∞—Ä–¥–∏–æ', name: '–ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –±–µ–≥/—Ö–æ–¥—å–±–∞', sets: '20 –º–∏–Ω', note: '' },
        ],
        gain: [
          { muscle: '–ì—Ä—É–¥—å', name: '–û—Ç–∂–∏–º–∞–Ω–∏—è —Å —É–∑–∫–æ–π –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π', sets: '4√ó10‚Äì12', note: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –Ω–µ–≥–∞—Ç–∏–≤' },
          { muscle: '–ù–æ–≥–∏', name: '–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ —Å–ø–ª–∏—Ç-–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è', sets: '4√ó10/–Ω–æ–≥–∞', note: '' },
          { muscle: '–°–ø–∏–Ω–∞', name: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è/–∞–≤—Ç–æ–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', sets: '4√ó–º–∞–∫—Å', note: '–†–µ–∑–∏–Ω–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏' },
          { muscle: '–ü–ª–µ—á–∏', name: '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –≤–≤–µ—Ä—Ö (–¥–æ–º–∞—à–Ω–∏–µ)', sets: '4√ó12', note: '' },
        ]
      },
      gym: {
        lose: [
          { muscle: '–ù–æ–≥–∏', name: '–ñ–∏–º –Ω–æ–≥–∞–º–∏', sets: '4√ó12‚Äì15', note: '' },
          { muscle: '–ì—Ä—É–¥—å', name: '–ñ–∏–º –ª—ë–∂–∞', sets: '4√ó8‚Äì10', note: '' },
          { muscle: '–°–ø–∏–Ω–∞', name: '–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞', sets: '4√ó10‚Äì12', note: '' },
          { muscle: '–ö–∞—Ä–¥–∏–æ', name: '–≠–ª–ª–∏–ø—Å–æ–∏–¥', sets: '20‚Äì30 –º–∏–Ω', note: '60‚Äì70% –ú–ß–°' },
        ],
        maintain: [
          { muscle: '–ü–ª–µ—á–∏', name: '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è', sets: '3√ó10‚Äì12', note: '' },
          { muscle: '–°–ø–∏–Ω–∞', name: '–¢—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞', sets: '3√ó10‚Äì12', note: '' },
          { muscle: '–ü—Ä–µ—Å—Å', name: '–ü–æ–¥—ä—ë–º –∫–æ–ª–µ–Ω –≤ –≤–∏—Å–µ', sets: '3√ó12‚Äì15', note: '' },
          { muscle: '–ù–æ–≥–∏', name: '–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ', sets: '3√ó12‚Äì15', note: '' },
        ],
        gain: [
          { muscle: '–ì—Ä—É–¥—å', name: '–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞', sets: '5√ó5‚Äì8', note: '–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏' },
          { muscle: '–°–ø–∏–Ω–∞', name: '–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ', sets: '5√ó5‚Äì8', note: '' },
          { muscle: '–ù–æ–≥–∏', name: '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è —Å–æ —à—Ç–∞–Ω–≥–æ–π', sets: '5√ó5', note: '' },
          { muscle: '–ü–ª–µ—á–∏', name: '–ñ–∏–º —à—Ç–∞–Ω–≥–∏ —Å—Ç–æ—è', sets: '4√ó6‚Äì8', note: '' },
        ]
      }
    };

    // ======= State & Storage =======
    const tg = window.Telegram?.WebApp;
    let UID = 'anon';
    if (tg && tg.initDataUnsafe?.user) {
      UID = String(tg.initDataUnsafe.user.id);
      tg.expand();
      document.getElementById('hello').textContent = `–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.user.first_name || '–¥—Ä—É–≥'}!`;
      tg.MainButton.setParams({ text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å', is_visible: false });
      tg.onEvent('mainButtonClicked', () => document.getElementById('saveProfile').click());
      document.body.style.background = tg.colorScheme === 'dark' ? '#0b0f14' : '#0b0f14';
    }

    const storeKey = (k) => `fitbalance:${UID}:${k}`;
    const read = (k, v=null) => { try { return JSON.parse(localStorage.getItem(storeKey(k))) ?? v } catch { return v } };
    const write = (k, v) => localStorage.setItem(storeKey(k), JSON.stringify(v));

    const state = {
      profile: read('profile', { gender: 'male', age: 28, height: 175, weight: 75, goal: 'maintain', activity: 1.375, location: 'home' }),
      meals: read('meals', {}), // map date -> [items]
      burns: read('burns', {}), // map date -> [items]
      kcalLimit: 0,
    };

    const todayKey = () => new Date().toISOString().slice(0,10);

    // ======= Helpers =======
    function fmt(n) { return Math.round(n); }
    function calcBMR({ gender, age, height, weight }) {
      // Mifflin‚ÄìSt Jeor
      return gender === 'male' ? 10*weight + 6.25*height - 5*age + 5 : 10*weight + 6.25*height - 5*age - 161;
    }
    function goalOffset(goal) { return goal==='lose' ? -400 : goal==='gain' ? 300 : 0 } // —Å–ø–æ–∫–æ–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    function macroTargets(weight, goal) {
      const p = goal==='gain' ? 1.8 : goal==='lose' ? 1.6 : 1.6; // g/kg
      const fat = 0.8; // g/kg
      return { protein: fmt(weight*p), fat: fmt(weight*fat) };
    }

    function foodsToOptions() {
      const sel = document.getElementById('foodSelect');
      sel.innerHTML = '<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç ‚Äî</option>' + LOCAL_DB.map((f,i)=>`<option value="${i}">${f.name} ‚Äî ${f.kcal} –∫–∫–∞–ª/100–≥</option>`).join('');
    }

    function addMealItem(name, grams, per100) {
      const d = todayKey();
      const list = state.meals[d] || (state.meals[d] = []);
      const factor = grams/100;
      const item = {
        name, grams,
        kcal: per100.kcal*factor,
        protein: (per100.protein||0)*factor,
        fat: (per100.fat||0)*factor,
        carbs: (per100.carbs||0)*factor,
      };
      list.push(item); write('meals', state.meals); renderMeals(); renderEnergy();
    }

    function addBurnItem(mins, intensity) {
      const d = todayKey();
      const list = state.burns[d] || (state.burns[d] = []);
      const met = intensity==='light' ? 4 : intensity==='moderate' ? 6 : 8; // —É—Å–ª–æ–≤–Ω—ã–π MET
      const kcal = (met * state.profile.weight * (mins/60));
      list.push({ mins, intensity, kcal }); write('burns', state.burns); renderBurns(); renderEnergy();
    }

    function sumDay(items) { return items?.reduce((a,b)=>a+b.kcal,0)||0 }
    function sumMacros(items, k) { return items?.reduce((a,b)=>a+(b[k]||0),0)||0 }

    function renderMeals() {
      const d = todayKey();
      const box = document.getElementById('meals'); box.innerHTML = '';
      const items = state.meals[d]||[];
      if (!items.length) { box.innerHTML = '<div class="text-white/60 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç.</div>'; return }
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-white/5 rounded-xl p-3';
        row.innerHTML = `<div><div class="font-medium">${it.name}</div><div class="text-xs text-white/60">${fmt(it.grams)} –≥ ‚Ä¢ ${fmt(it.kcal)} –∫–∫–∞–ª ‚Ä¢ –ë:${fmt(it.protein)} –ñ:${fmt(it.fat)} –£:${fmt(it.carbs)}</div></div>
        <button class="text-xs text-red-300" data-i="${idx}">–£–¥–∞–ª–∏—Ç—å</button>`;
        row.querySelector('button').onclick = (e)=>{ (state.meals[d]||[]).splice(Number(e.target.dataset.i),1); write('meals', state.meals); renderMeals(); renderEnergy(); };
        box.appendChild(row);
      })
    }

    function renderBurns() {
      const d = todayKey();
      const box = document.getElementById('burnLog'); box.innerHTML = '';
      const items = state.burns[d]||[];
      if (!items.length) { box.innerHTML = '<div class="text-white/60 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.</div>'; return }
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-white/5 rounded-xl p-3';
        row.innerHTML = `<div><div class="font-medium">${it.intensity} ‚Ä¢ ${fmt(it.mins)} –º–∏–Ω</div><div class="text-xs text-white/60">~ ${fmt(it.kcal)} –∫–∫–∞–ª</div></div>
        <button class="text-xs text-red-300" data-i="${idx}">–£–¥–∞–ª–∏—Ç—å</button>`;
        row.querySelector('button').onclick = (e)=>{ (state.burns[d]||[]).splice(Number(e.target.dataset.i),1); write('burns', state.burns); renderBurns(); renderEnergy(); };
        box.appendChild(row);
      })
    }

    function renderEnergy() {
      const prof = state.profile;
      const bmr = calcBMR(prof), tdee = bmr * Number(prof.activity);
      const limit = tdee + goalOffset(prof.goal);
      state.kcalLimit = limit; document.getElementById('kcalLimit').textContent = fmt(limit);
      const eaten = sumDay(state.meals[todayKey()]);
      const burned = sumDay(state.burns[todayKey()]);
      const net = eaten - burned;
      const remain = Math.max(0, limit - net);
      document.getElementById('kcalEaten').textContent = fmt(eaten);
      document.getElementById('kcalBurned').textContent = fmt(burned);
      document.getElementById('kcalNet').textContent = fmt(net);
      document.getElementById('kcalRemain').textContent = `${fmt(remain)} –∫–∫–∞–ª`;
      document.getElementById('goalBadge').textContent = `–¶–µ–ª—å: ${prof.goal==='lose'?'–ü–æ—Ö—É–¥–µ–Ω–∏–µ':prof.goal==='gain'?'–ú–∞—Å—Å–∞':'–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ'}`;
      // update wish helper
      const per100 = Number(document.getElementById('wishKcalPer100').value||0);
      if (per100>0) {
        const grams = Math.max(0, Math.floor((remain / per100) * 100));
        document.getElementById('wishResult').textContent = grams?`–ú–æ–∂–Ω–æ ~ ${grams} –≥, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç.`:'‚Äî';
      }
      renderHistory();
      renderWorkoutPlan();
    }

    function renderProfile() {
      const p = state.profile;
      document.getElementById('gender').value = p.gender;
      document.getElementById('age').value = p.age;
      document.getElementById('height').value = p.height;
      document.getElementById('weight').value = p.weight;
      document.getElementById('goal').value = p.goal;
      document.getElementById('activity').value = String(p.activity);
      document.getElementById('location').value = p.location;

      const bmr = calcBMR(p);
      const tdee = bmr * Number(p.activity);
      const limit = tdee + goalOffset(p.goal);
      const macros = macroTargets(p.weight, p.goal);
      const carbs = Math.max(0, Math.round((limit - (macros.protein*4 + macros.fat*9))/4));
      document.getElementById('bmr').textContent = fmt(bmr);
      document.getElementById('tdee').textContent = fmt(tdee);
      document.getElementById('limit').textContent = fmt(limit);
      document.getElementById('macros').textContent = `–ë:${macros.protein}–≥ –ñ:${macros.fat}–≥ –£:${carbs}–≥ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä)`;
      document.getElementById('locLabel').textContent = p.location==='gym'?'–∑–∞–ª':'–¥–æ–º';
    }

    function renderHistory() {
      const tbody = document.getElementById('history'); tbody.innerHTML = '';
      const days = Object.keys(state.meals).sort().slice(-14); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
      days.forEach(d=>{
        const meals = state.meals[d]||[];
        const burns = state.burns[d]||[];
        const kcal = (meals.reduce((a,b)=>a+b.kcal,0) - burns.reduce((a,b)=>a+b.kcal,0));
        const p = meals.reduce((a,b)=>a+(b.protein||0),0);
        const f = meals.reduce((a,b)=>a+(b.fat||0),0);
        const c = meals.reduce((a,b)=>a+(b.carbs||0),0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-3 text-white/80">${d}</td><td class="p-3">${fmt(kcal)}</td><td class="p-3">${fmt(p)}</td><td class="p-3">${fmt(f)}</td><td class="p-3">${fmt(c)}</td>`;
        tbody.appendChild(tr);
      })
    }

    function renderWorkoutPlan() {
      const wrap = document.getElementById('workoutPlan');
      wrap.innerHTML = '';
      const list = EXERCISES[state.profile.location][state.profile.goal];
      list.forEach(ex => {
        const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(ex.name + ' —Ç–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è')}`;
        const card = document.createElement('div');
        card.className = 'bg-white/5 rounded-xl p-4';
        card.innerHTML = `<div class="text-xs text-white/60">${ex.muscle}</div>
          <div class="font-semibold">${ex.name}</div>
          <div class="text-sm text-white/70">${ex.sets} ${ex.note?('‚Ä¢ '+ex.note):''}</div>
          <a class="inline-block mt-2 text-brand-300 underline" href="${url}" target="_blank" rel="noopener">–í–∏–¥–µ–æ</a>`;
        wrap.appendChild(card);
      })
    }

    // ======= Internet providers =======
    async function searchOpenFoodFacts(q) {
      try {
        const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&json=1&page_size=1`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('http');
        const data = await res.json();
        const p = data.products?.[0];
        if (!p) return null;
        const nutr = p.nutriments || {};
        const per100 = {
          kcal: nutr['energy-kcal_100g'] ?? nutr['energy-kcal'] ?? (nutr['energy_100g']? nutr['energy_100g']/4.184 : null),
          protein: nutr['proteins_100g'] ?? 0,
          fat: nutr['fat_100g'] ?? 0,
          carbs: nutr['carbohydrates_100g'] ?? 0,
        };
        if (!per100.kcal) return null;
        return { name: p.product_name || q, per100 };
      } catch (e) { return null }
    }

    // ======= Events =======
    document.addEventListener('DOMContentLoaded', () => {
      foodsToOptions();
      renderProfile();
      renderMeals();
      renderBurns();
      renderEnergy();

      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
          btn.classList.add('tab-active');
          const t = btn.dataset.tab;
          document.getElementById('tab-food').classList.toggle('hide', t!=='food');
          document.getElementById('tab-workouts').classList.toggle('hide', t!=='workouts');
          document.getElementById('tab-profile').classList.toggle('hide', t!=='profile');
        })
      })

      document.getElementById('foodSelect').addEventListener('change', e=>{
        const i = e.target.value; if (i==='') return;
        const f = LOCAL_DB[Number(i)];
        document.getElementById('foodName').value = f.name;
        document.getElementById('foodGrams').value = 100;
      })

      document.getElementById('addFood').addEventListener('click', ()=>{
        const name = document.getElementById('foodName').value.trim();
        let grams = Number(document.getElementById('foodGrams').value);
        if (!name || !grams) return alert('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏ –≥—Ä–∞–º–º—ã');
        // try to resolve per100 from local DB first
        let per100 = LOCAL_DB.find(f=>f.name.toLowerCase()===name.toLowerCase());
        if (!per100) {
          // heuristic: if selection chosen but edited name, try selected index
          const sel = document.getElementById('foodSelect');
          if (sel.value!=='') per100 = LOCAL_DB[Number(sel.value)];
        }
        if (!per100) { per100 = { kcal: 100, protein: 0, fat: 0, carbs: 0 }; }
        addMealItem(name, grams, per100);
        document.getElementById('foodName').value='';
        document.getElementById('foodGrams').value='';
        document.getElementById('foodSelect').value='';
      })

      document.getElementById('clearToday').addEventListener('click', ()=>{
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–ø–∏—Å–∏?')) return;
        state.meals[todayKey()] = []; write('meals', state.meals); renderMeals(); renderEnergy();
      })

      document.getElementById('calcWish').addEventListener('click', ()=>{
        const per100 = Number(document.getElementById('wishKcalPer100').value||0);
        if (!per100) { alert('–£–∫–∞–∂–∏—Ç–µ –∫–∫–∞–ª/100–≥ –¥–ª—è –æ—Ü–µ–Ω–∫–∏'); return }
        const remain = Math.max(0, state.kcalLimit - (sumDay(state.meals[todayKey()]) - sumDay(state.burns[todayKey()])));
        const grams = Math.max(0, Math.floor((remain / per100) * 100));
        document.getElementById('wishResult').textContent = grams?`–ú–æ–∂–Ω–æ ~ ${grams} –≥, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç.`:'‚Äî';
      })

      document.getElementById('addBurn').addEventListener('click', ()=>{
        const mins = Number(document.getElementById('mins').value||0);
        const intensity = document.getElementById('intensity').value;
        if (!mins) return alert('–£–∫–∞–∂–∏—Ç–µ –º–∏–Ω—É—Ç—ã');
        addBurnItem(mins, intensity);
        document.getElementById('mins').value='';
      })

      document.getElementById('saveProfile').addEventListener('click', ()=>{
        state.profile = {
          gender: document.getElementById('gender').value,
          age: Number(document.getElementById('age').value||28),
          height: Number(document.getElementById('height').value||175),
          weight: Number(document.getElementById('weight').value||75),
          goal: document.getElementById('goal').value,
          activity: Number(document.getElementById('activity').value),
          location: document.getElementById('location').value,
        };
        write('profile', state.profile);
        if (tg) { tg.HapticFeedback.impactOccurred('light'); tg.showAlert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }
        renderProfile(); renderEnergy();
      })

      document.getElementById('scanOpenFoodFacts').addEventListener('click', async ()=>{
        const q = prompt('–ß—Ç–æ –∏—â–µ–º?'); if (!q) return;
        const res = await searchOpenFoodFacts(q);
        if (!res) { alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–∫–∞–ª/100–≥ –≤—Ä—É—á–Ω—É—é.'); return }
        document.getElementById('foodName').value = res.name;
        document.getElementById('foodGrams').value = 100;
        alert(`${res.name}: ~${Math.round(res.per100.kcal)} –∫–∫–∞–ª/100–≥`);
      })

      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const data = { profile: state.profile, meals: state.meals, burns: state.burns };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `fitbalance-${UID}-${todayKey()}.json`; a.click();
      })
      document.getElementById('importFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        const text = await file.text();
        try { const data = JSON.parse(text); if (data.profile) state.profile = data.profile; if (data.meals) state.meals = data.meals; if (data.burns) state.burns = data.burns; write('profile', state.profile); write('meals', state.meals); write('burns', state.burns); renderProfile(); renderMeals(); renderBurns(); renderEnergy(); alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ'); } catch { alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
      })
    });
  </script>
</body>
</html>
